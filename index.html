<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="materialize.min.css">
    <link rel="stylesheet" href="style.css">

    <title>GameJam ENSICAEN 2020</title>
</head>
<body>
    <div id="gameContainer" class="valign-wrapper">
        <div id="startContainer">
            <img src="resources/imgs/logoed.png" width="15%" style="margin-left: 42.5%" alt="">
            <p class="center">Thème : inversion</p>
            <br>
            <h3 class="center">Memento</h3>
            <p id="intro"></p>
            <div id="start" class="but center"></div>
        </div>
        <div class="row"><div class="col s12 m12">

            <div id="sceneCard" class="card">
                <div class="center"><img id="sceneImg" class="responsive-img" src="" alt=""></div>
                <div class="card-content white-text center">
                    <span id="sceneHour" class="card-title"></span>
                    <p id="sceneContext"></p>
                </div>
                <div class="card-action">
                    <div id="sceneChoices" class="ligne">
                    </div>
                </div>
            </div>

        </div></div>

    </div>

    <div id="timeline" class="timelineContainer">
        <div class="timeline">
            <ul id="listOfEvents">
            </ul>
        </div>
        <div class="center">
            <div class="but" onclick="revealEnd()" style="margin-left: 25%;max-width: 50%;">Où suis-je ?</div>
        </div>
    </div>

    <div id="recap" class="">
        <h3></h3>
        <div id="listSumup" class="center">
            <p>Vous êtes étudiant, vous venez de passer une super soirée. Cependant vous ne savez pas où vous êtes. Vous essayez de vous remémorer la journée pour en déduire où vous êtes arrivé.</p>
            <p>fskjfhsihgjoidrjgoi, pendant vous ne savez pas où vous êtes. Vous essayez de vous remévous venez de passer une super soirée. Cemorer la journée pour en déduire où vous êtes arrivé.</p>
            <p>Vous êtes étudiant, vous venez de passer une super soirée. Cependant vous ne savez pas où vous êtes. Vous essayez de vous remémorer la journée pour en déduire où vous êtes arrivé.</p>
            <p>Vous êtes étudiantr une super soirée. Cependant vous ne sav  , vous venez de passeez pas où vous êtes. Vous essayez de vous remémorer la journée pour en déduire où vous êtes arrivé.</p>
            <p>Vous êtes étudiant, vous venez de passer une super soirée. Cependant vous ne savez pas où vous êtes. Vous essayez de vous remémorer la journée pour en déduire où vous êtes arrivé.</p>
            <p>Vous êtes étudiant, vous venez de passer une super soirée. Cependant vous ne savez pas où vous êtes. Vous essayez de vous remémorer la journée pour en déduire où vous êtes arrivé.</p>
        </div>

        <div id="againBut" class="but center" onclick="location.reload();">
            Recommencer une partie !
        </div>
    </div>

    <script src="jquery.js" charset="utf-8"></script>
    <script src="materialize.min.js" charset="utf-8"></script>
    <script src="story.js" charset="utf-8"></script>

    <script type="text/javascript">
    let events = new Array()
    let nSMS = 0
    let influences = {
        health: 0,
        love: 0,
        friends: 0,
        studies: 0,
        money: 0,
        reputation: 0
    }
    let tookTicket = true

    class ChoiceTemplate {

        constructor(choice, nChoices, index) {
            this.id = choice.id
            this.transition = choice.transition
            this.ncol = 12 / nChoices
            this.index = index
        }

        renderHTML(){
            return `<div class="but center" onclick="nextScene(${this.id}, ${this.index})" id="${this.id}">${this.transition.toUpperCase()}</div>`
        }
    }

    class TimepointTemplate {
        constructor(scene, resolution) {
            this.scene = scene
            this.resolution = resolution
        }

        renderHTML(){
            return `<li><div class="content">
            <h3>${this.scene.hour}</h3>
            <p>${this.resolution}</p></div>
            <div class="point"></div></li>`
        }
    }
    let currentScene = null
    // $("#startContainer").hide()
    $("#sceneCard").hide()
    $("#gameContainer").remove()
    $("#timeline").hide()
    // $("#recap").hide()

    // $("#start").remove()
    // loadInitialScene()

    $(document).ready(function() {
        $("#intro").empty()
        $("#intro").text(introductionText.introduction)
        $("#start").text(introductionText.buttonText)

        $("#start").click(function(){
            let a = new Audio();
            a.src = "resources/oneUp.wav"
            a.play()
            $("#startContainer").fadeOut(function(){
                $("#startContainer").remove()
                loadInitialScene()
            })
        })

    })

    function loadInitialScene(){
        currentScene = stories.reduce(function(prev, curr) {
            return prev.id < curr.id ? prev : curr;
        });
        loadScene(currentScene)
    }

    function loadScene(scene){
        $("#sceneChoices").empty()
        $("#sceneContext").text(scene.context)
        $("#sceneHour").text(scene.hour)
        $("#sceneImg").attr("src", scene.img)
        scene.choices.forEach((choice, index) => {
            $("#sceneChoices").append(new ChoiceTemplate(choice, scene.choices.length, index).renderHTML())
        });
        $("#sceneCard").fadeIn()
    }

    function nextScene(id, index){
        specificCases(id, index)
        updateInfluences(id, index)

        let resolution = currentScene.choices[index].resolution
        if(resolution != "")
        events.push([currentScene, resolution])
        currentScene = stories.filter(scene => scene.id == id)[0];
        if (currentScene.choices.length == 0){
            //Final Scene

            for(let prop in influences) {
                console.log(prop + " = " + influences[prop]);
            }

            $("#sceneCard").fadeOut(function(){
                loadTimeLine()
                $("#gameContainer").hide()
                $("#timeline").fadeIn()
            })
        }else{
            $("#sceneCard").fadeOut(function(){
                loadScene(currentScene)
                $("#sceneCard").fadeIn(500)
            })
        }
    }
    function loadTimeLine(){
        events.push([currentScene, "Vous vous réveillez"])
        while (events.length > 0){
            let i = events.pop()
            $("#listOfEvents").append(new TimepointTemplate(i[0], i[1]).renderHTML())
        }
    }

    function updateInfluences(id, index){
        influences.health     += currentScene.choices[index].influences.health
        influences.love       += currentScene.choices[index].influences.love
        influences.friends    += currentScene.choices[index].influences.friends
        influences.studies    += currentScene.choices[index].influences.studies
        influences.money      += currentScene.choices[index].influences.money
        influences.reputation += currentScene.choices[index].influences.reputation
    }

    function specificCases(id, index){
        switch(id){
            case 11:
            if (index != 1) {
                tookTicket = false
                influences.money -= 6
            }
            break
            case 22:
            if (index == 1) nSMS++
            break
            case 24:
            if (index == 1) nSMS++
            break
            case 25:
            if(index == 1) nSMS++
            break
            case 26:
            if (index == 1) nSMS++
            break
            case 28:
            if (index == 1) nSMS++
            break
            case 29:
            if (index == 1) nSMS++
            break
            case 30:
            switch (index){
                case 0: //Date
                influences.love += (nSMS * 2)
                break
                case 1: //APL
                influences.money += (nSMS * 2)
                break
                case 2: //Poto Paris
                influences.friends += (nSMS * 2)
                break
            }
            break
        }

    }

    function revealEnd(){
        $("#timeline").fadeOut(()=>{
            loadEndScene()
            $("#recap").fadeIn()
        })
    }

    function loadEndScene(){
        // $("#listSumup").append("<p> .... Vous êtes ici</p>")

    }

    </script>
</body>
</html>
